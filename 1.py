import os

# ==========================================
# 0. Prophet ì„ì‹œíŒŒì¼ì„ ì˜ë¬¸ í´ë”ë¡œ ê°•ì œ (í•œê¸€ ê²½ë¡œ ë¬¸ì œ íšŒí”¼)
# ==========================================
tmp_dir = r"C:\prophet_tmp"
os.makedirs(tmp_dir, exist_ok=True)
os.environ["TMP"] = tmp_dir
os.environ["TEMP"] = tmp_dir

# ==========================================
# 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ import
# ==========================================
import pandas as pd
from prophet import Prophet
from sklearn.metrics import r2_score
import matplotlib.pyplot as plt

# ==========================================
# 2. a10.csv ë¶ˆëŸ¬ì˜¤ê¸°
#    ğŸ‘‰ csv_pathëŠ” ë„¤ ì‹¤ì œ íŒŒì¼ ê²½ë¡œë¡œ ìˆ˜ì •í•´ì•¼ í•¨
# ==========================================
csv_path = r"C:\Users\ì´í˜œë¦°\OneDrive\ë°”íƒ• í™”ë©´\dblab\fpp2\a10.csv"  # ë„¤ ê²½ë¡œ ê·¸ëŒ€ë¡œ ë„£ìŒ

df_raw = pd.read_csv(csv_path)
print("ì›ë³¸ ë°ì´í„° ìƒìœ„ 5ê°œ:")
print(df_raw.head())

# ==========================================
# 3. Prophet í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ds, y)
#    a10ì€ 1991-07ë¶€í„° ì›”ë³„ ë°ì´í„°ë¼ì„œ ê·¸ê±¸ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ìƒì„±
# ==========================================
n = len(df_raw)

# 1991-07-01ë¶€í„° ì›” ë‹¨ìœ„ë¡œ nê°œ ìƒì„± (Month Start: MS)
dates = pd.date_range(start="1991-07-01", periods=n, freq="MS")

df = pd.DataFrame({
    "ds": dates,       # Prophetì´ ìš”êµ¬í•˜ëŠ” ë‚ ì§œ ì»¬ëŸ¼
    "y": df_raw["x"],  # ì˜ˆì¸¡í•  ê°’
})

print("\nProphetì— ë„£ì„ ë°ì´í„° ìƒìœ„ 5ê°œ:")
print(df.head())

# ==========================================
# 4. Prophet ëª¨ë¸ ìƒì„± ë° í•™ìŠµ
# ==========================================
model = Prophet()          # ê¸°ë³¸ ì„¤ì •
model.fit(df)              # ì „ì²´ ë°ì´í„°ë¡œ í•™ìŠµ

# ==========================================
# 5. ë¯¸ë˜ ë°ì´í„°í”„ë ˆì„ ìƒì„± + ì˜ˆì¸¡
#    - ì›ë˜ ê¸°ê°„ + ì•ìœ¼ë¡œ 12ê°œì›” ì˜ˆì¸¡
# ==========================================
future = model.make_future_dataframe(periods=12, freq="MS")
forecast = model.predict(future)

print("\nì˜ˆì¸¡ ê²°ê³¼ ì¼ë¶€:")
print(forecast[["ds", "yhat"]].tail())

# ==========================================
# 6. ì˜ˆì¸¡ ê·¸ë˜í”„ (ì „ì²´ ê¸°ê°„ + ë¯¸ë˜ 12ê°œì›”)
# ==========================================
model.plot(forecast)
plt.title("a10 ë°ì´í„° Prophet ì˜ˆì¸¡")
plt.xlabel("Date")
plt.ylabel("Value")
plt.show()

# ==========================================
# 7. RÂ² ê³„ì‚° (í•™ìŠµ êµ¬ê°„ì— ëŒ€í•œ ì„¤ëª…ë ¥)
#    - ì‹¤ì œê°’ y vs ëª¨ë¸ ì˜ˆì¸¡ê°’ yhatì„ ë¹„êµ
# ==========================================
merged = df.merge(forecast[["ds", "yhat"]], on="ds", how="left")

r2 = r2_score(merged["y"], merged["yhat"])
print(f"\nRÂ² (ê²°ì •ê³„ìˆ˜): {r2:.4f}")
